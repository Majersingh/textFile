<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On-Call Schedule Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .controls {
            /* position: sticky; */
            top: 0;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
        }

        .controls-header:hover {
            background: #f1f5f9;
        }

        .controls-title {
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls-toggle {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .controls-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .controls-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .controls-content.collapsed {
            max-height: 0;
        }

        .controls-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .global-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .rotation-configs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .rotation-config {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .rotation-config h3 {
            margin-bottom: 15px;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
        }

        .rotation-config.second-line h3 {
            color: #1e40af;
        }

        .rotation-config.third-line h3 {
            color: #166534;
        }

        .rotation-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .control-group input,
        .control-group select,
        .control-group textarea {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .control-group input:focus,
        .control-group select:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .control-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
            font-size: 12px;
            grid-column: 1 / -1;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 10px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #2563eb;
        }

        button:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .secondary-btn {
            background: #6b7280;
        }

        .secondary-btn:hover {
            background: #4b5563;
        }

        .schedule-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .current-oncall {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .current-oncall h3 {
            margin-bottom: 10px;
            color: #374151;
            font-size: 16px;
        }

        .current-assignees {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .current-assignee {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .current-assignee.second-line {
            background: #dbeafe;
            color: #1e40af;
        }

        .current-assignee.third-line {
            background: #dcfce7;
            color: #166534;
        }

        .timeline-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .timeline-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }

        .timeline-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .timeline-content {
            padding: 20px;
            overflow-x: auto;
        }

        .timeline-grid {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 0;
            min-width: 1200px;
        }

        .timeline-dates {
            display: flex;
            grid-column: 2;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .timeline-date {
            flex: 1;
            position: relative;
            padding: 10px 5px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            border-right: 1px solid #e5e7eb;
            min-width: 35px;
        }
        .timeline-date::after {
            content: "";
            position: absolute;
            top: -0px;
            bottom: -100px;
            right: 0;
            width: 1px;
            background-color: #d1d5db;
        }

        .timeline-date.today {
            background: #fef3c7;
            font-weight: 600;
        }

        .rotation-row {
            display: contents;
        }

        .rotation-label {
            display: flex;
            align-items: center;
            background: #f9fafb;
            border-right: 2px solid #e5e7eb;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .rotation-timeline {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            min-height: 60px;
            align-items: center;
            position: relative;
        }

        .timeline-segment {
            height: 35px;
            margin: 2px 1px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            cursor: help;
            transition: all 0.2s ease;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .timeline-segment:hover {
            transform: translateY(-50%) scale(1.02);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            z-index: 5;
        }

        .timeline-segment.second-line {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .timeline-segment.third-line {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #86efac;
        }

        /* this 3 are to make gap beween 2nd and 3rd use oncall */
        .timeline-segment.split {
            /* height: 16px; */
        }

        .timeline-segment.split.top {
            /* top: 25%; */
        }

        .timeline-segment.split.bottom {
            /* top: 75%; */
        }

        .timeline-day-container {
            flex: 1;
            min-width: 35px;
            position: relative;
            border-right: 1px solid #f1f5f9;
        }

        .tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
            z-index: 1000;
            max-width: 800px;
            word-wrap: break-word;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }

        @media (max-width: 1200px) {
            .rotation-configs {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .global-controls {
                grid-template-columns: 1fr;
            }
            
            .rotation-controls {
                grid-template-columns: 1fr;
            }
            
            .schedule-container {
                padding: 0 10px;
            }

            .timeline-grid {
                min-width: 800px;
            }

            .timeline-date {
                min-width: 25px;
                font-size: 11px;
            }

            .timeline-day-container {
                min-width: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="controls-header" onclick="toggleControls()">
            <div class="controls-title">
                ‚öôÔ∏è Configuration Settings
            </div>
            <div class="controls-toggle" id="controlsToggle">‚ñº</div>
        </div>
        <div class="controls-content" id="controlsContent" style="overflow: auto;">
            <div class="controls-container">
                <div class="global-controls">
                    <div class="control-group">
                        <label for="timeZone">Global Time Zone</label>
                        <select id="timeZone">
                            <option value="UTC">UTC</option>
                            <option value="Asia/Tokyo" selected>Asia/Tokyo</option>
                            <option value="Asia/Kolkata">Asia/Kolkata</option>
                            <option value="Europe/London">Europe/London</option>
                            <option value="America/New_York">America/New_York</option>
                            <option value="America/Los_Angeles">America/Los_Angeles</option>
                            <option value="Australia/Sydney">Australia/Sydney</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="timelineDays">Timeline Days</label>
                        <input type="number" id="timelineDays" value="30" min="7" max="90">
                    </div>
                </div>

                <div class="rotation-configs">
                    <!-- 2nd Line Configuration -->
                    <div class="rotation-config second-line">
                        <h3>üîµ 2nd Line Configuration</h3>
                        <div class="rotation-controls">
                            <div class="control-group">
                                <label for="startDateTime2nd">Start Date & Time</label>
                                <input type="datetime-local" id="startDateTime2nd" value="2025-08-27T08:00">
                            </div>
                            <div class="control-group">
                                <label for="shiftLength2nd">Shift Length (days)</label>
                                <input type="number" id="shiftLength2nd" value="2" min="1">
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="enable2ndLine" checked> Enable 2nd Line
                                </label>
                            </div>
                            <div class="control-group">
                                <label for="rotation2ndLine">2nd Line Rotation</label>
                                <textarea id="rotation2ndLine" placeholder="Enter emails, one per line or comma-separated">"john.doe@abc.com"
"jane.smith@abc.com"
"robert.johnson@abc.com"
"emily.davis@abc.com"
"michael.brown@abc.com"
"linda.wilson@abc.com"
"william.moore@abc.com"
"susan.taylor@abc.com"
"david.anderson@abc.com"
"patricia.thomas@abc.com"</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 3rd Line Configuration -->
                    <div class="rotation-config third-line">
                        <h3>üü¢ 3rd Line Configuration</h3>
                        <div class="rotation-controls">
                            <div class="control-group">
                                <label for="startDateTime3rd">Start Date & Time</label>
                                <input type="datetime-local" id="startDateTime3rd" value="2025-08-27T14:00">
                            </div>
                            <div class="control-group">
                                <label for="shiftLength3rd">Shift Length (days)</label>
                                <input type="number" id="shiftLength3rd" value="2" min="1">
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="enable3rdLine" checked> Enable 3rd Line
                                </label>
                            </div>
                            <div class="control-group">
                                <label for="rotation3rdLine">3rd Line Rotation</label>
                                <textarea id="rotation3rdLine" placeholder="Enter emails, one per line or comma-separated">"alex.miller@abc.com"
"sophia.clark@abc.com"
"daniel.lewis@abc.com"
"olivia.hall@abc.com"
"ethan.young@abc.com"
"mia.king@abc.com"
"noah.wright@abc.com"
"ava.scott@abc.com"
"liam.green@abc.com"
"isabella.adams@abc.com"</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="applySettings()">Apply Changes</button>
                    <button onclick="jumpToToday()" class="secondary-btn">Today</button>
                    <button onclick="downloadConfig()" class="secondary-btn">Download JSON</button>
                    <button onclick="loadSampleData()" class="secondary-btn">Load Sample Data</button>
                </div>
            </div>
        </div>
    </div>

    <div class="schedule-container">
        <div class="current-oncall">
            <h3>On call now:</h3>
            <div class="current-assignees" id="currentAssignees">
                <!-- Current on-call will be populated here -->
            </div>
        </div>

        <div class="timeline-container">
            <div class="timeline-header">
                <div class="timeline-title" id="timelineTitle">Schedule Timeline</div>
                <div class="timeline-nav">
                    <button onclick="prevPeriod()" class="secondary-btn">‚Üê Previous</button>
                    <button onclick="jumpToToday()" class="secondary-btn">Today</button>
                    <button onclick="nextPeriod()" class="secondary-btn">Next ‚Üí</button>
                </div>
            </div>
            
            <div class="timeline-content">
                <div class="timeline-grid" id="timelineGrid">
                    <!-- Timeline will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStartDate = new Date();
        let config = {
            timeZone: 'Asia/Tokyo',
            timelineDays: 30,
            secondLine: {
                enabled: true,
                startDateTime: '2025-08-27T08:00',
                shiftLength: 2,
                rotation: []
            },
            thirdLine: {
                enabled: true,
                startDateTime: '2025-08-27T14:00',
                shiftLength: 2,
                rotation: []
            }
        };

        const platform_2nd_line_users_new = [
            "john.doe@abc.com",
            "jane.smith@abc.com",
            "robert.johnson@abc.com",
            "emily.davis@abc.com",
            "michael.brown@abc.com",
            "linda.wilson@abc.com",
            "william.moore@abc.com",
            "susan.taylor@abc.com",
            "david.anderson@abc.com",
            "patricia.thomas@abc.com"
        ];

        const sample_3rd_line_users = [
            "alex.miller@abc.com",
            "sophia.clark@abc.com",
            "daniel.lewis@abc.com",
            "olivia.hall@abc.com",
            "ethan.young@abc.com",
            "mia.king@abc.com",
            "noah.wright@abc.com",
            "ava.scott@abc.com",
            "liam.green@abc.com",
            "isabella.adams@abc.com"
        ];

        function toggleControls() {
            const content = document.getElementById('controlsContent');
            const toggle = document.getElementById('controlsToggle');
            
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        function parseRotationInput(input) {
            if (!input.trim()) return [];
            return input.split(/[,\n]/)
                .map(email => email.trim())
                .filter(email => email.length > 0)
                .map(email => email.replace(/^["']|["']$/g, '')); // Remove quotes
        }

        // FIXED: This function now handles exact datetime shifts, not just day-based shifts
        function computeAssigneeForDate(rotationList, startDateTime, shiftDays, timeZone, targetDate) {
            if (rotationList.length === 0) return null;

            const startDate = new Date(startDateTime);
            const targetDateTime = new Date(targetDate);
            
            // Calculate shift duration in milliseconds (preserves hour/minute precision)
            const shiftDurationMs = shiftDays * 24 * 60 * 60 * 1000;
            
            // Calculate elapsed time in milliseconds from the exact start datetime
            const elapsedMs = targetDateTime.getTime() - startDate.getTime();
            
            // Calculate how many full shift intervals have elapsed
            const shiftsElapsed = Math.floor(elapsedMs / shiftDurationMs);
            
            // Handle negative time (before start) by ensuring positive rotation index
            const assigneeIndex = shiftsElapsed % rotationList.length;
            const normalizedIndex = assigneeIndex < 0 ? assigneeIndex + rotationList.length : assigneeIndex;
            
            // Calculate the exact start and end times of the current shift block
            const currentShiftStart = new Date(startDate.getTime() + (shiftsElapsed * shiftDurationMs));
            const currentShiftEnd = new Date(currentShiftStart.getTime() + shiftDurationMs);
            
            return {
                user: rotationList[normalizedIndex],
                shiftStart: currentShiftStart,
                shiftEnd: currentShiftEnd
            };
        }

        function formatShiftWindow(startDate, endDate, timeZone) {
            const options = {
                timeZone: timeZone,
                hour: 'numeric',
                minute: '2-digit',
                day: 'numeric',
                month: 'short',
                hour12: true
            };
            
            const startStr = new Intl.DateTimeFormat('en-US', options).format(startDate);
            const endStr = new Intl.DateTimeFormat('en-US', options).format(endDate);
            
            return `${startStr} ‚Üí ${endStr} (${timeZone})`;
        }

        function generateTimelineDates(startDate, days) {
            const dates = [];
            const current = new Date(startDate);
            
            for (let i = 0; i < days; i++) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        // FIXED: Calculate position based on timeline start/end, not day index
        function calculateSegmentPosition(shiftStart, shiftEnd, timelineStart, timelineEnd) {
            const timelineStartMs = timelineStart.getTime();
            const timelineEndMs = timelineEnd.getTime();
            const timelineDurationMs = timelineEndMs - timelineStartMs;

            // Clamp shift times to timeline bounds
            const segmentStartMs = Math.max(shiftStart.getTime(), timelineStartMs);
            const segmentEndMs = Math.min(shiftEnd.getTime(), timelineEndMs);

            // If no overlap, return null
            if (segmentEndMs <= segmentStartMs) return null;

            // Calculate position as percentage of total timeline
            const leftPercent = ((segmentStartMs - timelineStartMs) / timelineDurationMs) * 100;
            const widthPercent = ((segmentEndMs - segmentStartMs) / timelineDurationMs) * 100;

            return { leftPercent, widthPercent };
        }

        function generateSegmentsForRotation(rotationConfig, timelineStart, timelineEnd, lineType) {
            if (!rotationConfig.enabled || rotationConfig.rotation.length === 0) {
                return [];
            }

            const segments = [];
            const rotationStartDate = new Date(rotationConfig.startDateTime);
            const shiftDurationMs = rotationConfig.shiftLength * 24 * 60 * 60 * 1000;

            // Find the first shift that intersects with our timeline
            const elapsedSinceRotationStart = timelineStart.getTime() - rotationStartDate.getTime();
            let firstShiftIndex = Math.floor(elapsedSinceRotationStart / shiftDurationMs);
            
            // Go back one shift to ensure we don't miss any partial overlaps
            firstShiftIndex -= 1;

            // Generate shifts until we're past the timeline end
            let shiftIndex = firstShiftIndex;
            while (true) {
                const shiftStartMs = rotationStartDate.getTime() + (shiftIndex * shiftDurationMs);
                const shiftEndMs = shiftStartMs + shiftDurationMs;
                
                const shiftStart = new Date(shiftStartMs);
                const shiftEnd = new Date(shiftEndMs);

                // If this shift starts after our timeline ends, we're done
                if (shiftStart.getTime() >= timelineEnd.getTime()) break;

                // If this shift ends before our timeline starts, skip it
                if (shiftEnd.getTime() <= timelineStart.getTime()) {
                    shiftIndex++;
                    continue;
                }

                // Calculate position
                const position = calculateSegmentPosition(shiftStart, shiftEnd, timelineStart, timelineEnd);
                if (position) {
                    const userIndex = shiftIndex % rotationConfig.rotation.length;
                    const normalizedIndex = userIndex < 0 ? userIndex + rotationConfig.rotation.length : userIndex;
                    
                    segments.push({
                        user: rotationConfig.rotation[normalizedIndex],
                        shiftStart,
                        shiftEnd,
                        leftPercent: position.leftPercent,
                        widthPercent: position.widthPercent,
                        lineType
                    });
                }

                shiftIndex++;
            }

            return segments;
        }

        function checkOverlap(segments2nd, segments3rd, leftPercent, widthPercent) {
            const segmentStart = leftPercent;
            const segmentEnd = leftPercent + widthPercent;

            const overlapping2nd = segments2nd.filter(s => {
                const sStart = s.leftPercent;
                const sEnd = s.leftPercent + s.widthPercent;
                return !(sEnd <= segmentStart || sStart >= segmentEnd);
            });

            const overlapping3rd = segments3rd.filter(s => {
                const sStart = s.leftPercent;
                const sEnd = s.leftPercent + s.widthPercent;
                return !(sEnd <= segmentStart || sStart >= segmentEnd);
            });

            return {
                has2nd: overlapping2nd.length > 0,
                has3rd: overlapping3rd.length > 0
            };
        }

        function renderTimeline() {
            const grid = document.getElementById('timelineGrid');
            const title = document.getElementById('timelineTitle');
            
            const dates = generateTimelineDates(currentStartDate, config.timelineDays);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Calculate timeline bounds
            const timelineStart = new Date(currentStartDate);
            timelineStart.setHours(0, 0, 0, 0);
            const timelineEnd = new Date(timelineStart);
            timelineEnd.setTime(timelineEnd.getTime() + (config.timelineDays * 24 * 60 * 60 * 1000));
            
            // Update title
            const startStr = currentStartDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            const endDate = new Date(currentStartDate);
            endDate.setDate(endDate.getDate() + config.timelineDays - 1);
            const endStr = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            title.textContent = `${startStr} - ${endStr}`;
            
            // Clear existing content
            grid.innerHTML = '';
            
            // Create dates header
            const emptyCorner = document.createElement('div');
            grid.appendChild(emptyCorner);
            
            const datesContainer = document.createElement('div');
            datesContainer.className = 'timeline-dates';
            
            dates.forEach(date => {
                const dateCell = document.createElement('div');
                dateCell.className = 'timeline-date';
                
                const cellDate = new Date(date);
                cellDate.setHours(0, 0, 0, 0);
                if (cellDate.getTime() === today.getTime()) {
                    dateCell.classList.add('today');
                }
                
                dateCell.innerHTML = `<div>${date.getDate()}</div><div style="font-size: 10px; color: #6b7280;">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>`;
                datesContainer.appendChild(dateCell);
            });
            
            grid.appendChild(datesContainer);
            
            // Generate segments based on timeline bounds
            const segments2nd = generateSegmentsForRotation(config.secondLine, timelineStart, timelineEnd, 'second-line');
            const segments3rd = generateSegmentsForRotation(config.thirdLine, timelineStart, timelineEnd, 'third-line');
            
            // Create rotation rows
            if (config.secondLine.enabled && config.secondLine.rotation.length > 0) {
                const label = document.createElement('div');
                label.className = 'rotation-label';
                label.innerHTML = '<strong>2nd Line</strong>';
                grid.appendChild(label);
                
                const timeline = document.createElement('div');
                timeline.className = 'rotation-timeline';
                
                // Create day containers
                dates.forEach((date, index) => {
                    const dayContainer = document.createElement('div');
                    dayContainer.className = 'timeline-day-container';
                    timeline.appendChild(dayContainer);
                });
                
                // Add segments
                segments2nd.forEach(segment => {
                    const segmentEl = document.createElement('div');
                    const overlap = checkOverlap(segments2nd, segments3rd, segment.leftPercent, segment.widthPercent);
                    
                    segmentEl.className = `timeline-segment ${segment.lineType}`;
                    if (overlap.has2nd && overlap.has3rd) {
                        segmentEl.classList.add('split', 'top');
                    }
                    
                    segmentEl.style.width = `${segment.widthPercent}%`;
                    segmentEl.style.left = `${segment.leftPercent}%`;
                    
                    const userName = segment.user.split('@')[0];
                    segmentEl.textContent = userName.length > 10 ? userName.substring(0, 10) + '...' : userName;
                    
                    const tooltipText = `${segment.user} | ${formatShiftWindow(segment.shiftStart, segment.shiftEnd, config.timeZone)}`;
                    segmentEl.addEventListener('mouseenter', (e) => showTooltip(e, tooltipText));
                    segmentEl.addEventListener('mouseleave', hideTooltip);
                    
                    timeline.appendChild(segmentEl);
                });
                
                grid.appendChild(timeline);
            }
            
            if (config.thirdLine.enabled && config.thirdLine.rotation.length > 0) {
                const label = document.createElement('div');
                label.className = 'rotation-label';
                label.innerHTML = '<strong>3rd Line</strong>';
                grid.appendChild(label);
                
                const timeline = document.createElement('div');
                timeline.className = 'rotation-timeline';
                
                // Create day containers
                dates.forEach((date, index) => {
                    const dayContainer = document.createElement('div');
                    dayContainer.className = 'timeline-day-container';
                    timeline.appendChild(dayContainer);
                });
                
                // Add segments
                segments3rd.forEach(segment => {
                    const segmentEl = document.createElement('div');
                    const overlap = checkOverlap(segments2nd, segments3rd, segment.leftPercent, segment.widthPercent);
                    
                    segmentEl.className = `timeline-segment ${segment.lineType}`;
                    if (overlap.has2nd && overlap.has3rd) {
                        segmentEl.classList.add('split', 'bottom');
                    }
                    
                    segmentEl.style.width = `${segment.widthPercent}%`;
                    segmentEl.style.left = `${segment.leftPercent}%`;
                    
                    const userName = segment.user.split('@')[0];
                    segmentEl.textContent = userName.length > 10 ? userName.substring(0, 10) + '...' : userName;
                    
                    const tooltipText = `${segment.user} | ${formatShiftWindow(segment.shiftStart, segment.shiftEnd, config.timeZone)}`;
                    segmentEl.addEventListener('mouseenter', (e) => showTooltip(e, tooltipText));
                    segmentEl.addEventListener('mouseleave', hideTooltip);
                    
                    timeline.appendChild(segmentEl);
                });
                
                grid.appendChild(timeline);
            }
            
            updateCurrentOnCall();
        }

        function updateCurrentOnCall() {
            const container = document.getElementById('currentAssignees');
            container.innerHTML = '';
            
            const now = new Date();
            
            if (config.secondLine.enabled && config.secondLine.rotation.length > 0) {
                const assignment = computeAssigneeForDate(
                    config.secondLine.rotation,
                    config.secondLine.startDateTime,
                    config.secondLine.shiftLength,
                    config.timeZone,
                    now
                );
                
                if (assignment) {
                    const div = document.createElement('div');
                    div.className = 'current-assignee second-line';
                    div.innerHTML = `<strong>2nd Line:</strong> ${assignment.user.split('@')[0]}`;
                    container.appendChild(div);
                }
            }
            
            if (config.thirdLine.enabled && config.thirdLine.rotation.length > 0) {
                const assignment = computeAssigneeForDate(
                    config.thirdLine.rotation,
                    config.thirdLine.startDateTime,
                    config.thirdLine.shiftLength,
                    config.timeZone,
                    now
                );
                
                if (assignment) {
                    const div = document.createElement('div');
                    div.className = 'current-assignee third-line';
                    div.innerHTML = `<strong>3rd Line:</strong> ${assignment.user.split('@')[0]}`;
                    container.appendChild(div);
                }
            }
        }

        let currentTooltip = null;

        function showTooltip(event, text) {
            hideTooltip();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = text;
            
            document.body.appendChild(tooltip);
            currentTooltip = tooltip;
            
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
            
            if (tooltip.offsetLeft < 5) {
                tooltip.style.left = '5px';
            }
            if (tooltip.offsetLeft + tooltip.offsetWidth > window.innerWidth - 5) {
                tooltip.style.left = (window.innerWidth - tooltip.offsetWidth - 5) + 'px';
            }
        }

        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }

        function applySettings() {
            config.timeZone = document.getElementById('timeZone').value;
            config.timelineDays = parseInt(document.getElementById('timelineDays').value);
            
            config.secondLine.enabled = document.getElementById('enable2ndLine').checked;
            config.secondLine.startDateTime = document.getElementById('startDateTime2nd').value;
            config.secondLine.shiftLength = parseInt(document.getElementById('shiftLength2nd').value);
            config.secondLine.rotation = parseRotationInput(document.getElementById('rotation2ndLine').value);
            
            config.thirdLine.enabled = document.getElementById('enable3rdLine').checked;
            config.thirdLine.startDateTime = document.getElementById('startDateTime3rd').value;
            config.thirdLine.shiftLength = parseInt(document.getElementById('shiftLength3rd').value);
            config.thirdLine.rotation = parseRotationInput(document.getElementById('rotation3rdLine').value);
            
            renderTimeline();
        }

        function prevPeriod() {
            currentStartDate.setDate(currentStartDate.getDate() - config.timelineDays);
            renderTimeline();
        }

        function nextPeriod() {
            currentStartDate.setDate(currentStartDate.getDate() + config.timelineDays);
            renderTimeline();
        }

        function jumpToToday() {
            currentStartDate = new Date();
            currentStartDate.setHours(0, 0, 0, 0);
            renderTimeline();
        }

        function loadSampleData() {
            document.getElementById('rotation2ndLine').value = platform_2nd_line_users_new.join('\n');
            document.getElementById('rotation3rdLine').value = sample_3rd_line_users.join('\n');
            document.getElementById('enable2ndLine').checked = true;
            document.getElementById('enable3rdLine').checked = true;
        }

        function downloadConfig() {
            const configData = {
                timeZone: config.timeZone,
                timelineDays: config.timelineDays,
                secondLine: config.secondLine,
                thirdLine: config.thirdLine
            };
            
            const blob = new Blob([JSON.stringify(configData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oncall-schedule-config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('rotation2ndLine').value = platform_2nd_line_users_new.join('\n');
            document.getElementById('rotation3rdLine').value = sample_3rd_line_users.join('\n');
            
            currentStartDate = new Date();
            currentStartDate.setHours(0, 0, 0, 0);
            
            applySettings();
        });
    </script>
</body>
</html>
